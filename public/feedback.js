import{r as n,f as q,Y as W,j as r,V as J,W as Q,x as Z,c as ee,d as te,ad as O,a0 as oe,ae as P,_ as ne,ac as se,b as ae}from"./assets/FeedbackSidebar-D0atEsN9.js";const re=()=>{var _;console.log("FeedbackTool: Mounting...");const[s,M]=n.useState(null),[a,N]=n.useState(null),[m,A]=n.useState([]),[i,E]=n.useState(!1),[S,w]=n.useState(!0),[b,I]=n.useState("right"),[U,L]=n.useState("comments"),[T,z]=n.useState([]),[f,B]=n.useState("desktop"),[c,V]=n.useState("comment"),[l,g]=n.useState({isOpen:!1,x:0,y:0}),D=n.useRef(null),[u,p]=n.useState(null),y=((_=q.currentUser)==null?void 0:_.uid)||"guest-user";n.useEffect(()=>{const t=document.querySelector('script[src*="feedback.js"]');if(t){const e=t.getAttribute("data-project-id"),o=t.getAttribute("data-feedback-id");console.log("FeedbackTool: Config found",{pid:e,fid:o}),M(e),N(o)}else console.warn("FeedbackTool: Script tag not found or missing attributes")},[]),n.useEffect(()=>{(async()=>{try{console.log("FeedbackTool: Fetching users...");const o=(await Z(ee(te,"users"))).docs.map(d=>({id:d.id,...d.data()}));console.log("FeedbackTool: Users fetched",o.length),z(o)}catch(e){console.error("FeedbackTool: Error fetching users:",e)}})()},[]),n.useEffect(()=>{const t=e=>{var o;((o=e.data)==null?void 0:o.type)==="FEEDBACK_TOOL_UPDATE"&&(console.log("FeedbackTool: Received update",e.data.payload),e.data.payload.device&&B(e.data.payload.device),e.data.payload.interactionMode&&V(e.data.payload.interactionMode))};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[]),n.useEffect(()=>{if(!s||!a)return;console.log("FeedbackTool: Subscribing to comments...");const t=W(s,a,e=>{console.log("FeedbackTool: Comments updated",e.length),A(e)});return()=>t()},[s,a]);const k=n.useMemo(()=>m.filter(t=>!t.device||t.device===f),[m,f]),G=n.useMemo(()=>k.map((t,e)=>({id:t.id,x:t.x_coordinate||0,y:t.y_coordinate||0,number:t.pin_number||e+1})),[k]),h=n.useCallback(t=>{if(!i||c==="navigate"){u&&p(null);return}const e=document.elementFromPoint(t.clientX,t.clientY);e&&!e.closest("#client-dashboard-feedback-tool")?p(e):p(null)},[i,c,u]);n.useEffect(()=>(i&&c==="comment"?(document.addEventListener("mousemove",h),document.body.style.cursor="crosshair"):(document.removeEventListener("mousemove",h),document.body.style.cursor="default",p(null)),()=>{document.removeEventListener("mousemove",h),document.body.style.cursor="default"}),[i,c,h]);const v=n.useCallback(t=>{if(!i||!s||!a||c==="navigate"||t.target.closest("#client-dashboard-feedback-tool"))return;t.preventDefault(),t.stopPropagation();const o=t.pageX,d=t.pageY;g({isOpen:!0,x:o,y:d,isNew:!0}),E(!1)},[i,s,a,c]);n.useEffect(()=>(i&&c==="comment"?document.addEventListener("click",v,!0):document.removeEventListener("click",v,!0),()=>document.removeEventListener("click",v,!0)),[i,c,v]);const Y=async(t,e)=>{if(!(!s||!a))try{if(l.isNew){const d=m.filter(x=>x.pageUrl===window.location.pathname&&x.device===f).reduce((x,H)=>Math.max(x,H.pin_number||0),0),X=await ne(s,a,{authorId:y,commentText:t,resolved:!1,x_coordinate:l.x,y_coordinate:l.y,pin_number:d+1,pageUrl:window.location.pathname,device:f,dueDate:e==null?void 0:e.dueDate,status:"Active",replies:[]});e!=null&&e.dueDate&&await P(X,t,e.dueDate,y,s)}else l.comment;g({isOpen:!1,x:0,y:0})}catch(o){console.error("Failed to submit comment",o),alert("Failed to save comment.")}},$=async(t,e)=>{if(!(!s||!a)&&(await O(s,a,t,e),e.dueDate)){const o=m.find(d=>d.id===t);o&&o.commentText&&await P(t,o.commentText,e.dueDate,y,s)}},j=t=>{const e=t;e.pageUrl&&e.pageUrl!==window.location.pathname&&window.parent.postMessage({type:"FEEDBACK_TOOL_NAVIGATE",payload:{url:e.pageUrl,device:e.device||"desktop"}},"*"),e.x_coordinate!==void 0&&e.y_coordinate!==void 0&&(window.scrollTo({top:e.y_coordinate-window.innerHeight/2,behavior:"smooth"}),g({isOpen:!0,x:e.x_coordinate,y:e.y_coordinate,comment:e,isNew:!1}))},F=async t=>{var e;!s||!a||(await oe(s,a,t),((e=l.comment)==null?void 0:e.id)===t&&g({isOpen:!1,x:0,y:0}))},R=async t=>{if(!s||!a)return;const e=m.find(o=>o.id===t);if(e){const o=e.status==="Resolved"?"Active":"Resolved";await O(s,a,t,{status:o,resolved:o==="Resolved"})}},K=(t,e)=>{window.parent.postMessage({type:"FEEDBACK_TOOL_NAVIGATE",payload:{url:t,device:e}},"*")};return!s||!a?(console.log("FeedbackTool: Missing project or feedback ID",{projectId:s,feedbackItemId:a}),null):r.jsxs("div",{className:"feedback-tool-root font-sans",id:"client-dashboard-feedback-tool",ref:D,style:{pointerEvents:"none",position:"absolute",width:"100%",height:"100%",top:0,left:0,zIndex:2147483647},children:[u&&i&&c==="comment"&&r.jsx("div",{style:{position:"absolute",top:u.getBoundingClientRect().top+window.scrollY,left:u.getBoundingClientRect().left+window.scrollX,width:u.getBoundingClientRect().width,height:u.getBoundingClientRect().height,border:"2px solid #3b82f6",backgroundColor:"rgba(59, 130, 246, 0.1)",pointerEvents:"none",zIndex:2147483646}}),G.map(t=>{const e=m.find(d=>d.id===t.id);if(!e)return null;const o=e.status==="Resolved";return r.jsx("div",{style:{position:"absolute",top:t.y,left:t.x,zIndex:2147483647,transform:"translate(-50%, -50%)",pointerEvents:"auto",opacity:o?.5:1},className:`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer transition-transform hover:scale-110 ${o?"bg-green-500":"bg-blue-600"}`,title:e.commentText,onClick:d=>{d.stopPropagation(),j(e)},children:t.number},t.id)}),!S&&r.jsx("button",{onClick:()=>w(!0),className:"fixed top-4 right-4 z-[2147483647] bg-black text-white px-4 py-2 rounded shadow-lg hover:bg-gray-800 pointer-events-auto",children:"Show Feedback"}),S&&r.jsxs("div",{className:`fixed z-[2147483647] shadow-2xl bg-white border-border-color pointer-events-auto flex flex-col transition-all duration-300 ${b==="right"?"top-0 right-0 h-full w-96 border-l":"bottom-0 left-0 w-full h-72 border-t"}`,children:[r.jsxs("div",{className:"absolute top-2 right-2 flex gap-2 z-10",children:[r.jsx("button",{onClick:()=>I(t=>t==="right"?"bottom":"right"),className:"p-1 rounded bg-gray-100 hover:bg-gray-200 text-xs",title:"Toggle Dock Position",children:b==="right"?"Bottom Dock":"Right Dock"}),r.jsx("button",{onClick:()=>w(!1),className:"p-1 rounded hover:bg-red-100 text-red-500",children:"Ã—"})]}),r.jsx(J,{view:U,onViewChange:L,comments:k,onCommentClick:j,onClose:()=>w(!1),onDelete:F,onResolve:R,position:b,onGoToPage:K,users:T}),r.jsx("div",{className:`p-4 bg-white border-gray-200 ${b==="right"?"border-t":"border-r w-48 flex-shrink-0 flex items-center"}`,children:r.jsx("button",{onClick:()=>E(!i),disabled:c==="navigate",className:`w-full py-2 px-4 rounded font-medium transition-colors ${c==="navigate"?"bg-gray-300 cursor-not-allowed":i?"bg-red-100 text-red-700 hover:bg-red-200":"bg-blue-600 text-white hover:bg-blue-700"}`,children:c==="navigate"?"Switch to Comment Mode":i?"Cancel Commenting":"Add Comment"})})]}),l.isOpen&&r.jsx("div",{className:"pointer-events-auto",style:{position:"relative",zIndex:2147483647},children:r.jsx(Q,{comment:l.comment||null,coords:{x:l.x,y:l.y},contentRef:D,zoom:1,onClose:()=>g({isOpen:!1,x:0,y:0}),onSubmit:Y,onUpdate:$,onResolve:R,onDelete:F,targetType:"website",users:T})})]})},C=document.createElement("div");C.id="client-dashboard-feedback-tool";document.body.appendChild(C);const ie=se.createRoot(C);ie.render(r.jsx(ae.StrictMode,{children:r.jsx(re,{})}));
