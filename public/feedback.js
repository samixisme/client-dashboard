import{r as s,c as _,a1 as $,j as l,Y as G,D as J,e as Q,h as V,a7 as Z,a5 as T,a9 as j,a4 as ee,ak as te,a as oe}from"./assets/CommentPopover-rqz3ODNG.js";const ne=()=>{var D;const[r,w]=s.useState(null),[i,C]=s.useState(null),[c,O]=s.useState([]),[y,P]=s.useState(!1),[R,A]=s.useState([]),[h,N]=s.useState("desktop"),[S,F]=s.useState("comment"),[a,m]=s.useState({isOpen:!1,x:0,y:0}),U=s.useRef(null),[v,I]=s.useState(null),[g,E]=s.useState(((D=_.currentUser)==null?void 0:D.uid)||"");s.useEffect(()=>{const t=_.onAuthStateChanged(e=>{E(e?e.uid:"guest-user")});return()=>t()},[]),s.useEffect(()=>{const t=document.querySelector('script[src*="feedback.js"]');if(t){const e=t.getAttribute("data-project-id"),o=t.getAttribute("data-feedback-id");w(e),C(o)}else{const e=document.querySelector("script[data-project-id]");if(e){const o=e.getAttribute("data-project-id"),n=e.getAttribute("data-feedback-id");w(o),C(n)}else console.warn("FeedbackTool: Script tag not found or missing attributes")}},[]),s.useEffect(()=>{(async()=>{try{const o=(await J(Q(V,"users"))).docs.map(n=>({id:n.id,...n.data()}));A(o)}catch(e){console.error("FeedbackTool: Error fetching users:",e)}})()},[]),s.useEffect(()=>{if(!r||!i)return;const t=$(r,i,e=>{O(e)});return()=>{t()}},[r,i]),s.useEffect(()=>{const t=e=>{var o,n;if(((o=e.data)==null?void 0:o.type)==="FEEDBACK_TOOL_UPDATE"&&(e.data.payload.device&&N(e.data.payload.device),e.data.payload.interactionMode&&(F(e.data.payload.interactionMode),P(e.data.payload.interactionMode==="comment"))),((n=e.data)==null?void 0:n.type)==="SCROLL_TO_PIN"){const{x:p,y:b,commentId:u}=e.data.payload;if(window.scrollTo({top:b-window.innerHeight/2,behavior:"smooth"}),u){const f=c.find(W=>W.id===u);f&&m({isOpen:!0,x:f.x_coordinate||p,y:f.y_coordinate||b,comment:f,isNew:!1})}}};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[c]);const k=()=>{const e=new URLSearchParams(window.location.search).get("url")||window.location.href;return e.endsWith("/")&&e.length>1?e.slice(0,-1):e},M=s.useMemo(()=>{const t=k();return c.filter(e=>{const o=e.pageUrl&&e.pageUrl.endsWith("/")&&e.pageUrl.length>1?e.pageUrl.slice(0,-1):e.pageUrl||"";return(!e.device||e.device===h)&&o===t})},[c,h]),L=s.useMemo(()=>M.map((t,e)=>({id:t.id,x:t.x_coordinate||0,y:t.y_coordinate||0,number:t.pin_number||e+1})),[M]),z=t=>{if(!y||!r||!i||S==="navigate")return;t.preventDefault(),t.stopPropagation();const e=t.pageX,o=t.pageY;m({isOpen:!0,x:e,y:o,isNew:!0})},Y=t=>{const o=document.elementsFromPoint(t.clientX,t.clientY).find(n=>!n.closest("#client-dashboard-feedback-tool"));o&&o!==v?I(o):o||I(null)},X=async(t,e)=>{if(!(!r||!i))try{if(a.isNew){const o=k(),p=c.filter(u=>u.pageUrl===o&&u.device===h).reduce((u,f)=>Math.max(u,f.pin_number||0),0),b=await ee(r,i,{authorId:g,commentText:t,x_coordinate:a.x,y_coordinate:a.y,pin_number:p+1,pageUrl:o,device:h,dueDate:e==null?void 0:e.dueDate,status:"Active",replies:[]});e!=null&&e.dueDate&&await j(b,t,e.dueDate,g,r)}else a.comment;m({isOpen:!1,x:0,y:0})}catch(o){console.error("Failed to submit comment",o),alert("Failed to save comment.")}},q=async(t,e)=>{if(!r||!i)return;const o={...e};if(e.comment&&(o.commentText=e.comment,delete o.comment),await T(r,i,t,o),e.dueDate){const n=c.find(p=>p.id===t);n&&n.commentText&&await j(t,n.commentText,e.dueDate,g,r)}},B=async t=>{var e;!r||!i||(await Z(r,i,t),((e=a.comment)==null?void 0:e.id)===t&&m({isOpen:!1,x:0,y:0}))},H=async t=>{if(!r||!i)return;const e=c.find(o=>o.id===t);if(e){const o=e.status==="Resolved"?"Active":"Resolved";await T(r,i,t,{status:o,resolved:o==="Resolved"})}},K=t=>{window.parent.postMessage({type:"PIN_CLICKED",payload:{commentId:t.id}},"*"),t.x_coordinate!==void 0&&t.y_coordinate!==void 0&&m({isOpen:!0,x:t.x_coordinate,y:t.y_coordinate,comment:t,isNew:!1})},d=s.useMemo(()=>!a.isOpen||!a.comment?null:a.isNew?a.comment:c.find(t=>{var e;return t.id===((e=a.comment)==null?void 0:e.id)})||a.comment,[a.isOpen,a.comment,a.isNew,c]);return!r||!i?null:l.jsxs("div",{className:"feedback-tool-root font-sans",id:"client-dashboard-feedback-tool",ref:U,style:{pointerEvents:"none",position:"absolute",width:"100%",height:"100%",top:0,left:0,zIndex:2147483647},children:[y&&S==="comment"&&l.jsx("div",{onClick:z,onMouseMove:Y,style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:2147483645,cursor:"crosshair",pointerEvents:"auto",background:"transparent"}}),y&&v&&(()=>{const t=v.getBoundingClientRect(),e=t.top+window.scrollY,o=t.left+window.scrollX;return l.jsx("div",{style:{position:"absolute",top:e,left:o,width:t.width,height:t.height,border:"2px solid #A3E635",backgroundColor:"rgba(163, 230, 53, 0.2)",pointerEvents:"none",zIndex:2147483646,transition:"all 0.1s ease-out"}})})(),L.map(t=>{const e=c.find(n=>n.id===t.id);if(!e)return null;const o=e.status==="Resolved";return l.jsx("div",{style:{position:"absolute",top:t.y,left:t.x,zIndex:2147483647,transform:"translate(-50%, -50%)",pointerEvents:"auto",opacity:o?.5:1},className:`w-8 h-8 rounded-full flex items-center justify-center text-black font-bold shadow-lg cursor-pointer transition-transform hover:scale-110 ${o?"bg-green-500":"bg-[#A3E635]"}`,title:e.commentText,onClick:n=>{n.stopPropagation(),K(e)},children:t.number},t.id)}),a.isOpen&&l.jsx("div",{className:"pointer-events-auto",style:{position:"relative",zIndex:2147483647},children:l.jsx(G,{comment:d?{id:d.id,projectId:r||"",targetId:i||"",targetType:"website",comment:d.commentText,reporterId:d.authorId,status:d.status||"Active",timestamp:typeof d.createdAt=="string"?d.createdAt:new Date().toISOString(),pin_number:d.pin_number||0,dueDate:d.dueDate,replies:d.replies}:null,coords:{x:a.x,y:a.y},contentRef:U,zoom:1,onClose:()=>m({isOpen:!1,x:0,y:0}),onSubmit:X,onUpdate:q,onResolve:H,onDelete:B,targetType:"website",users:R,currentUserId:g})})]})},x=document.createElement("div");x.id="client-dashboard-feedback-tool";document.body.appendChild(x);const se=te.createRoot(x);se.render(l.jsx(oe.StrictMode,{children:l.jsx(ne,{})}));
