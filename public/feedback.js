import{r as s,c as D,W as $,j as l,U as Z,B as G,e as J,h as Q,$ as V,Z as F,a0 as _,Y as ee,ab as te,a as oe}from"./assets/CommentPopover-U4FFXX_a.js";const ne=()=>{var M;console.log("FeedbackTool: Mounting...");const[a,w]=s.useState(null),[r,k]=s.useState(null),[c,j]=s.useState([]),[y,R]=s.useState(!1),[O,P]=s.useState([]),[g,A]=s.useState("desktop"),[C,N]=s.useState("comment"),[i,m]=s.useState({isOpen:!1,x:0,y:0}),T=s.useRef(null),[v,U]=s.useState(null),[h,S]=s.useState(((M=D.currentUser)==null?void 0:M.uid)||"");s.useEffect(()=>{const t=D.onAuthStateChanged(e=>{e?(console.log("FeedbackTool: User authenticated",e.uid),S(e.uid)):(console.log("FeedbackTool: User not authenticated"),S("guest-user"))});return()=>t()},[]),s.useEffect(()=>{const t=document.querySelector('script[src*="feedback.js"]');if(t){const e=t.getAttribute("data-project-id"),o=t.getAttribute("data-feedback-id");console.log("FeedbackTool: Config found",{pid:e,fid:o}),w(e),k(o)}else{const e=document.querySelector("script[data-project-id]");if(e){const o=e.getAttribute("data-project-id"),n=e.getAttribute("data-feedback-id");console.log("FeedbackTool: Config found (module)",{pid:o,fid:n}),w(o),k(n)}else console.warn("FeedbackTool: Script tag not found or missing attributes")}},[]),s.useEffect(()=>{(async()=>{try{console.log("FeedbackTool: Fetching users...");const o=(await G(J(Q,"users"))).docs.map(n=>({id:n.id,...n.data()}));console.log("FeedbackTool: Users fetched",o.length),P(o)}catch(e){console.error("FeedbackTool: Error fetching users:",e)}})()},[]),s.useEffect(()=>{if(!a||!r)return;console.log("FeedbackTool: Subscribing to comments...");const t=$(a,r,e=>{console.log("FeedbackTool: Comments updated",e.length),j(e)});return()=>{t()}},[a,r]),s.useEffect(()=>{const t=e=>{var o,n;if(((o=e.data)==null?void 0:o.type)==="FEEDBACK_TOOL_UPDATE"&&(console.log("FeedbackTool: Received update",e.data.payload),e.data.payload.device&&A(e.data.payload.device),e.data.payload.interactionMode&&(N(e.data.payload.interactionMode),R(e.data.payload.interactionMode==="comment"))),((n=e.data)==null?void 0:n.type)==="SCROLL_TO_PIN"){const{x:p,y:b,commentId:u}=e.data.payload;if(window.scrollTo({top:b-window.innerHeight/2,behavior:"smooth"}),u){const f=c.find(K=>K.id===u);f&&m({isOpen:!0,x:f.x_coordinate||p,y:f.y_coordinate||b,comment:f,isNew:!1})}}};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[c]);const I=()=>{const e=new URLSearchParams(window.location.search).get("url")||window.location.href;return e.endsWith("/")&&e.length>1?e.slice(0,-1):e},E=s.useMemo(()=>{const t=I();return c.filter(e=>{const o=e.pageUrl&&e.pageUrl.endsWith("/")&&e.pageUrl.length>1?e.pageUrl.slice(0,-1):e.pageUrl||"";return(!e.device||e.device===g)&&o===t})},[c,g]),L=s.useMemo(()=>E.map((t,e)=>({id:t.id,x:t.x_coordinate||0,y:t.y_coordinate||0,number:t.pin_number||e+1})),[E]),z=t=>{if(!y||!a||!r||C==="navigate")return;t.preventDefault(),t.stopPropagation();const e=t.pageX,o=t.pageY;m({isOpen:!0,x:e,y:o,isNew:!0})},Y=t=>{const o=document.elementsFromPoint(t.clientX,t.clientY).find(n=>!n.closest("#client-dashboard-feedback-tool"));o&&o!==v?U(o):o||U(null)},B=async(t,e)=>{if(!(!a||!r))try{if(i.isNew){const o=I(),p=c.filter(u=>u.pageUrl===o&&u.device===g).reduce((u,f)=>Math.max(u,f.pin_number||0),0),b=await ee(a,r,{authorId:h,commentText:t,x_coordinate:i.x,y_coordinate:i.y,pin_number:p+1,pageUrl:o,device:g,dueDate:e==null?void 0:e.dueDate,status:"Active",replies:[]});e!=null&&e.dueDate&&await _(b,t,e.dueDate,h,a)}else i.comment;m({isOpen:!1,x:0,y:0})}catch(o){console.error("Failed to submit comment",o),alert("Failed to save comment.")}},W=async(t,e)=>{if(!a||!r)return;const o={...e};if(e.comment&&(o.commentText=e.comment,delete o.comment),await F(a,r,t,o),e.dueDate){const n=c.find(p=>p.id===t);n&&n.commentText&&await _(t,n.commentText,e.dueDate,h,a)}},X=async t=>{var e;!a||!r||(await V(a,r,t),((e=i.comment)==null?void 0:e.id)===t&&m({isOpen:!1,x:0,y:0}))},q=async t=>{if(!a||!r)return;const e=c.find(o=>o.id===t);if(e){const o=e.status==="Resolved"?"Active":"Resolved";await F(a,r,t,{status:o,resolved:o==="Resolved"})}},H=t=>{window.parent.postMessage({type:"PIN_CLICKED",payload:{commentId:t.id}},"*"),t.x_coordinate!==void 0&&t.y_coordinate!==void 0&&m({isOpen:!0,x:t.x_coordinate,y:t.y_coordinate,comment:t,isNew:!1})},d=s.useMemo(()=>!i.isOpen||!i.comment?null:i.isNew?i.comment:c.find(t=>{var e;return t.id===((e=i.comment)==null?void 0:e.id)})||i.comment,[i.isOpen,i.comment,i.isNew,c]);return!a||!r?(console.log("FeedbackTool: Missing project or feedback ID",{projectId:a,feedbackItemId:r}),null):l.jsxs("div",{className:"feedback-tool-root font-sans",id:"client-dashboard-feedback-tool",ref:T,style:{pointerEvents:"none",position:"absolute",width:"100%",height:"100%",top:0,left:0,zIndex:2147483647},children:[y&&C==="comment"&&l.jsx("div",{onClick:z,onMouseMove:Y,style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:2147483645,cursor:"crosshair",pointerEvents:"auto",background:"transparent"}}),y&&v&&(()=>{const t=v.getBoundingClientRect(),e=t.top+window.scrollY,o=t.left+window.scrollX;return l.jsx("div",{style:{position:"absolute",top:e,left:o,width:t.width,height:t.height,border:"2px solid #A3E635",backgroundColor:"rgba(163, 230, 53, 0.2)",pointerEvents:"none",zIndex:2147483646,transition:"all 0.1s ease-out"}})})(),L.map(t=>{const e=c.find(n=>n.id===t.id);if(!e)return null;const o=e.status==="Resolved";return l.jsx("div",{style:{position:"absolute",top:t.y,left:t.x,zIndex:2147483647,transform:"translate(-50%, -50%)",pointerEvents:"auto",opacity:o?.5:1},className:`w-8 h-8 rounded-full flex items-center justify-center text-black font-bold shadow-lg cursor-pointer transition-transform hover:scale-110 ${o?"bg-green-500":"bg-[#A3E635]"}`,title:e.commentText,onClick:n=>{n.stopPropagation(),H(e)},children:t.number},t.id)}),i.isOpen&&l.jsx("div",{className:"pointer-events-auto",style:{position:"relative",zIndex:2147483647},children:l.jsx(Z,{comment:d?{id:d.id,projectId:a||"",targetId:r||"",targetType:"website",comment:d.commentText,reporterId:d.authorId,status:d.status||"Active",timestamp:typeof d.createdAt=="string"?d.createdAt:new Date().toISOString(),pin_number:d.pin_number||0,dueDate:d.dueDate,replies:d.replies}:null,coords:{x:i.x,y:i.y},contentRef:T,zoom:1,onClose:()=>m({isOpen:!1,x:0,y:0}),onSubmit:B,onUpdate:W,onResolve:q,onDelete:X,targetType:"website",users:O,currentUserId:h})})]})},x=document.createElement("div");x.id="client-dashboard-feedback-tool";document.body.appendChild(x);const se=te.createRoot(x);se.render(l.jsx(oe.StrictMode,{children:l.jsx(ne,{})}));
