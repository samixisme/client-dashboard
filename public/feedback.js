import{r as o,f as A,Y as B,j as s,V as z,W as $,ad as Y,$ as X,a0 as H,_ as K,ae as V,ac as q,b as G}from"./assets/FeedbackSidebar-B86_MjTc.js";const W=()=>{var R;const[n,I]=o.useState(null),[r,O]=o.useState(null),[f,M]=o.useState([]),[c,C]=o.useState(!1),[k,x]=o.useState(!0),[b,T]=o.useState("right"),[y,L]=o.useState("desktop"),[a,P]=o.useState("comment"),[d,m]=o.useState({isOpen:!1,x:0,y:0}),E=o.useRef(null),[l,g]=o.useState(null),j=((R=A.currentUser)==null?void 0:R.uid)||"guest-user";o.useEffect(()=>{const e=document.querySelector('script[src*="feedback.js"]');e&&(I(e.getAttribute("data-project-id")),O(e.getAttribute("data-feedback-id")))},[]),o.useEffect(()=>{const e=t=>{var i;((i=t.data)==null?void 0:i.type)==="FEEDBACK_TOOL_UPDATE"&&(t.data.payload.device&&L(t.data.payload.device),t.data.payload.interactionMode&&P(t.data.payload.interactionMode))};return window.addEventListener("message",e),()=>window.removeEventListener("message",e)},[]),o.useEffect(()=>{if(!n||!r)return;const e=B(n,r,t=>{M(t)});return()=>e()},[n,r]);const p=o.useMemo(()=>f.filter(e=>!e.device||e.device===y),[f,y]),F=o.useMemo(()=>p.map((e,t)=>({id:e.id,x:e.x_coordinate||0,y:e.y_coordinate||0,number:e.pin_number||t+1})),[p]),h=o.useCallback(e=>{if(!c||a==="navigate"){l&&g(null);return}const t=document.elementFromPoint(e.clientX,e.clientY);t&&!t.closest("#client-dashboard-feedback-tool")?g(t):g(null)},[c,a,l]);o.useEffect(()=>(c&&a==="comment"?(document.addEventListener("mousemove",h),document.body.style.cursor="crosshair"):(document.removeEventListener("mousemove",h),document.body.style.cursor="default",g(null)),()=>{document.removeEventListener("mousemove",h),document.body.style.cursor="default"}),[c,a,h]);const v=o.useCallback(e=>{if(!c||!n||!r||a==="navigate"||e.target.closest("#client-dashboard-feedback-tool"))return;e.preventDefault(),e.stopPropagation();const i=e.pageX,u=e.pageY;m({isOpen:!0,x:i,y:u,isNew:!0}),C(!1)},[c,n,r,a]);o.useEffect(()=>(c&&a==="comment"?document.addEventListener("click",v,!0):document.removeEventListener("click",v,!0),()=>document.removeEventListener("click",v,!0)),[c,a,v]);const U=async(e,t)=>{if(!(!n||!r))try{if(d.isNew){const i=p.length+1,u=await K(n,r,{authorId:j,commentText:e,resolved:!1,x_coordinate:d.x,y_coordinate:d.y,pin_number:i,pageUrl:window.location.pathname,device:y,dueDate:t==null?void 0:t.dueDate});t!=null&&t.dueDate&&await V(u,e,t.dueDate,j,n)}else d.comment;m({isOpen:!1,x:0,y:0})}catch(i){console.error("Failed to submit comment",i),alert("Failed to save comment.")}},S=async(e,t)=>{!n||!r||(await Y(n,r,e,t),t.dueDate)},D=e=>{const t=e;t.pageUrl&&t.pageUrl!==window.location.pathname&&window.parent.postMessage({type:"FEEDBACK_TOOL_NAVIGATE",payload:{url:t.pageUrl}},"*"),t.x_coordinate!==void 0&&t.y_coordinate!==void 0&&(window.scrollTo({top:t.y_coordinate-window.innerHeight/2,behavior:"smooth"}),m({isOpen:!0,x:t.x_coordinate,y:t.y_coordinate,comment:t,isNew:!1}))},_=async e=>{var t;!n||!r||(await H(n,r,e),((t=d.comment)==null?void 0:t.id)===e&&m({isOpen:!1,x:0,y:0}))},N=async e=>{if(!n||!r)return;const t=f.find(i=>i.id===e);t&&await X(n,r,e,t.resolved)};return!n||!r?null:s.jsxs("div",{className:"feedback-tool-root font-sans",ref:E,style:{pointerEvents:a==="navigate"?"none":"auto",position:"absolute",width:"100%",height:"100%",top:0,left:0},children:[l&&c&&a==="comment"&&s.jsx("div",{style:{position:"absolute",top:l.getBoundingClientRect().top+window.scrollY,left:l.getBoundingClientRect().left+window.scrollX,width:l.getBoundingClientRect().width,height:l.getBoundingClientRect().height,border:"2px solid #3b82f6",backgroundColor:"rgba(59, 130, 246, 0.1)",pointerEvents:"none",zIndex:9999}}),F.map(e=>{const t=f.find(u=>u.id===e.id);if(!t)return null;const i=t.resolved;return s.jsx("div",{style:{position:"absolute",top:e.y,left:e.x,zIndex:1e4,transform:"translate(-50%, -50%)",pointerEvents:"auto",opacity:i?.5:1},className:`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer transition-transform hover:scale-110 ${i?"bg-green-500":"bg-blue-600"}`,title:t.commentText,onClick:u=>{u.stopPropagation(),D(t)},children:e.number},e.id)}),!k&&s.jsx("button",{onClick:()=>x(!0),className:"fixed top-4 right-4 z-[10001] bg-black text-white px-4 py-2 rounded shadow-lg hover:bg-gray-800 pointer-events-auto",children:"Show Feedback"}),k&&s.jsxs("div",{className:`fixed z-[10001] shadow-2xl bg-white border-border-color pointer-events-auto flex flex-col transition-all duration-300 ${b==="right"?"top-0 right-0 h-full w-96 border-l":"bottom-0 left-0 w-full h-72 border-t"}`,children:[s.jsxs("div",{className:"absolute top-2 right-2 flex gap-2 z-10",children:[s.jsx("button",{onClick:()=>T(e=>e==="right"?"bottom":"right"),className:"p-1 rounded bg-gray-100 hover:bg-gray-200 text-xs",title:"Toggle Dock Position",children:b==="right"?"Bottom Dock":"Right Dock"}),s.jsx("button",{onClick:()=>x(!1),className:"p-1 rounded hover:bg-red-100 text-red-500",children:"Ã—"})]}),s.jsx(z,{view:"comments",comments:p,onCommentClick:D,onClose:()=>x(!1),onDelete:_,onResolve:N,onUpdate:S,position:b}),s.jsx("div",{className:`p-4 bg-white border-gray-200 ${b==="right"?"border-t":"border-r w-48 flex-shrink-0 flex items-center"}`,children:s.jsx("button",{onClick:()=>C(!c),disabled:a==="navigate",className:`w-full py-2 px-4 rounded font-medium transition-colors ${a==="navigate"?"bg-gray-300 cursor-not-allowed":c?"bg-red-100 text-red-700 hover:bg-red-200":"bg-blue-600 text-white hover:bg-blue-700"}`,children:a==="navigate"?"Switch to Comment Mode":c?"Cancel Commenting":"Add Comment"})})]}),d.isOpen&&s.jsx("div",{className:"pointer-events-auto",children:s.jsx($,{comment:d.comment||null,coords:{x:d.x,y:d.y},contentRef:E,zoom:1,onClose:()=>m({isOpen:!1,x:0,y:0}),onSubmit:U,onUpdate:S,onResolve:N,onDelete:_,targetType:"website"})})]})},w=document.createElement("div");w.id="client-dashboard-feedback-tool";document.body.appendChild(w);const J=q.createRoot(w);J.render(s.jsx(G.StrictMode,{children:s.jsx(W,{})}));
